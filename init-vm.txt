#cloud-config
pacakage_update: true
packages:  
    - build-essential
    - curl https://raw.githubusercontent.com/EricBAllen/revature-p1/master/vm.html 
    - file
    - git
    - nodejs
write_files:
    - owner: 'ericazure:ericazure'
      path: '/home/ericazure/app.js'
      content: |
        const http = require('http');

        const hostname = '0.0.0.0';
        const port = 8000;

        const server = http.createServer((req, res) => {
            res.statusCode = 200;
            res.setHeader('Content-Type', 'vm.html');
            res.end('index.ejs');
        });

# app.get........

        server.listen(port, hostname, () => {
            console.log(`Server running at http://${hostname}:${port}/`);
        });

runcmd:
    - cd '/home/ericazure/'
    - node server.js
    - sudo mkfs -t ext4 /dev/sdc
    - sudo mkdir /media/diskDirectory
    - sudo mount /dev/sdc /media/diskDirectory
    - sudo mv server.js /media/diskDirectory/
    - sudo unmount /media/diskDirectory # unmount disk
    - sudo waagent deprovision+user -force # deprovision vm
    



    # INDEX.JS IS BELOW .......

    const express = require('express');
const multer = require('multer');
const ejs = require('ejs');
const path = require('path');
const js = require('js');
const app = express();
const port = 8000

app.set('view engine', 'js');
app.use(express.static('./public'))

app.get('/', (req, res) => res.render('index'))

app.post('/upload', (req, res) => { // we use app.post request to /uploads
  upload(req, res, (err) => {
    if(err){
      res.render('index', {
        msg: err
      });
    } else {
      console.log(req.file);
      res.send('test');
    }

  })
})

app.listen(port, () => console.log(`Example app listening on port ${port}!`))